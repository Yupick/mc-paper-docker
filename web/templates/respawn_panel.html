<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Respawn - MMORPG</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <style>
        .respawn-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .zone-card {
            background-color: #1a1a1a;
            border: 2px solid #00a366;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 163, 102, 0.2);
        }

        .zone-card.disabled {
            border-color: #666;
            opacity: 0.6;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .zone-title {
            font-size: 18px;
            font-weight: bold;
            color: #00a366;
        }

        .zone-type {
            display: inline-block;
            padding: 4px 10px;
            background-color: #00a366;
            color: #000;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .zone-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-box {
            background-color: #2a2a2a;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #00a366;
            font-size: 18px;
            font-weight: bold;
        }

        .mob-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .progress-bar {
            flex: 1;
            height: 25px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #00a366;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00a366, #00d999);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 11px;
        }

        .zone-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .btn-control {
            flex: 1;
            padding: 10px;
            border: 1px solid #00a366;
            background-color: transparent;
            color: #00a366;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-control:hover {
            background-color: #00a366;
            color: #000;
        }

        .btn-control.danger {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .btn-control.danger:hover {
            background-color: #ff6b6b;
            color: #fff;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #00a366;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .global-settings {
            background-color: #1a1a1a;
            border: 2px solid #ff9500;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .settings-title {
            color: #ff9500;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .setting-label {
            color: #e0e0e0;
        }

        .zones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .zones-grid {
                grid-template-columns: 1fr;
            }

            .zone-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="respawn-container">
        <header class="dashboard-header">
            <h1>Sistema de Respawn de Mobs</h1>
            <p>Administraci√≥n de zonas y configuraci√≥n de respawns autom√°ticos</p>
        </header>

        <!-- Configuraci√≥n Global -->
        <div class="global-settings">
            <div class="settings-title">‚öôÔ∏è Configuraci√≥n Global</div>
            
            <div class="setting-item">
                <span class="setting-label">Respawn Global Habilitado</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="respawn-enabled" onchange="updateGlobalSettings()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <span class="setting-label">Intervalo de Chequeo (segundos)</span>
                <input type="number" id="check-interval" min="5" max="60" value="1" 
                       style="width: 100px; padding: 5px; background-color: #333; color: #00a366; border: 1px solid #00a366; border-radius: 4px;"
                       onchange="updateGlobalSettings()">
            </div>

            <div class="setting-item">
                <span class="setting-label">Log de Respawns</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="log-respawns" onchange="updateGlobalSettings()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Zonas de Respawn -->
        <div>
            <h2 style="color: #00a366; margin-bottom: 20px;">üó∫Ô∏è Zonas de Respawn</h2>
            <div id="zones-container" class="zones-grid">
                <div style="grid-column: 1/-1; text-align: center; color: #888;">
                    Cargando zonas...
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadRespawnZones() {
            try {
                const response = await fetch('/api/rpg/respawn/zones');
                const data = await response.json();

                if (data.success) {
                    renderZones(data.zones);
                    renderGlobalSettings(data.globalSettings);
                }
            } catch (error) {
                console.error('Error cargando zonas:', error);
            }
        }

        function renderGlobalSettings(settings) {
            document.getElementById('respawn-enabled').checked = settings.respawnEnabled !== false;
            document.getElementById('check-interval').value = settings.checkInterval || 20;
            document.getElementById('log-respawns').checked = settings.logRespawns !== false;
        }

        function renderZones(zones) {
            const container = document.getElementById('zones-container');
            
            if (Object.keys(zones).length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888;">No hay zonas de respawn configuradas</div>';
                return;
            }

            container.innerHTML = Object.entries(zones).map(([zoneId, zone]) => `
                <div class="zone-card ${!zone.enabled ? 'disabled' : ''}">
                    <div class="zone-header">
                        <div>
                            <div class="zone-title">${zone.name}</div>
                            <span class="zone-type">${zone.type.toUpperCase()}</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" ${zone.enabled ? 'checked' : ''} 
                                   onchange="updateZoneStatus('${zoneId}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="zone-stats">
                        <div class="stat-box">
                            <div class="stat-label">Mobs Vivos</div>
                            <div class="stat-value">${zone.currentMobs || 0}/${zone.maxMobs}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Intervalo</div>
                            <div class="stat-value">${zone.respawnInterval}s</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Mundo</div>
                            <div class="stat-value">${zone.world}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Mobs</div>
                            <div class="stat-value">${zone.mobIds.length}</div>
                        </div>
                    </div>

                    <div class="mob-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(zone.currentMobs / zone.maxMobs * 100) || 0}%">
                                ${zone.currentMobs}/${zone.maxMobs}
                            </div>
                        </div>
                    </div>

                    <div class="zone-controls">
                        <button class="btn-control" onclick="editZone('${zoneId}', ${zone.maxMobs}, ${zone.respawnInterval})">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn-control danger" onclick="forceRespawn('${zoneId}')">
                            ‚ö° Forzar Respawn
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function updateZoneStatus(zoneId, enabled) {
            try {
                const response = await fetch(`/api/rpg/respawn/zones/${zoneId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled})
                });

                if (response.ok) {
                    loadRespawnZones();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function updateGlobalSettings() {
            const data = {
                respawnEnabled: document.getElementById('respawn-enabled').checked,
                checkInterval: parseInt(document.getElementById('check-interval').value),
                logRespawns: document.getElementById('log-respawns').checked
            };

            try {
                await fetch('/api/rpg/respawn/global', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                loadRespawnZones();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function editZone(zoneId, maxMobs, interval) {
            const newMax = prompt(`M√°ximo de mobs para ${zoneId}:`, maxMobs);
            if (newMax !== null) {
                updateZoneSettings(zoneId, parseInt(newMax), interval);
            }
        }

        async function updateZoneSettings(zoneId, maxMobs, interval) {
            try {
                await fetch(`/api/rpg/respawn/zones/${zoneId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({maxMobs, respawnInterval: interval})
                });
                
                loadRespawnZones();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function forceRespawn(zoneId) {
            if (confirm(`¬øForzar respawn inmediato en ${zoneId}?`)) {
                console.log('Forzar respawn en:', zoneId);
                // Implementar en futuro si es necesario
            }
        }

        // Cargar al iniciar
        document.addEventListener('DOMContentLoaded', loadRespawnZones);

        // Auto-refresh cada 10 segundos
        setInterval(loadRespawnZones, 10000);
    </script>
</body>
</html>
